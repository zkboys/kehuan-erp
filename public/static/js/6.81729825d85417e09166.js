webpackJsonp([6],{1377:function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}function r(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.mapStateToProps=t.default=t.PAGE_ROUTE=void 0;var u,c,d,s=(n(616),n(615)),f=a(s),m=(n(36),n(64)),p=a(m),h=(n(613),n(612)),y=a(h),g=(n(35),n(31)),b=a(g),v=(n(138),n(137)),S=a(v),P=(n(282),n(281)),O=a(P),E=(n(606),n(605)),k=a(E),w=(n(82),n(81)),_=a(w),C=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},I=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),T=n(0),j=a(T),x=n(43),N=n(176),R=n(83),D=n(1),U=a(D),A=n(1389),F=n(1414),L=a(F),V=n(50),q=(t.PAGE_ROUTE="/orders/send(/+edit/:id)",u=(0,N.ajax)(),c=_.default.create(),u(d=c(d=function(e){function t(){var e,n,a,l;o(this,t);for(var u=arguments.length,c=Array(u),d=0;d<u;d++)c[d]=arguments[d];return n=a=i(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(c))),a.state={loading:!1,isAdd:!0,isDetail:!1,data:{},dataSource:[],organizations:[],showProductSelect:!1},a.columns=[{title:"名称",dataIndex:"name",key:"name"},{title:"规格",dataIndex:"spec",key:"spec"},{title:"型号",dataIndex:"model",key:"model"},{title:"单位",dataIndex:"unit",key:"unit",render:function(e){var t=A.units.find(function(t){return t.code===e});return t?t.name:e}},{title:"单价",dataIndex:"unitPrice",key:"unitPrice",render:function(e,t){var n=A.units.find(function(e){return e.code===t.unit});return n?e+"元/"+n.shortName:e}},{title:"单个总量",dataIndex:"singleUnit",key:"singleUnit",render:function(e,t){var n=A.units.find(function(e){return e.code===t.unit});return n?""+e+n.shortName:e}},{title:"单个总价",dataIndex:"singleUnitPrice",key:"singleUnitPrice",render:function(e){return e+"元"}},{title:"库存总数",dataIndex:"stockCount",key:"stockCount",render:function(e){return e<V.STOCK_THRESHOLD_COUNT?j.default.createElement("span",{style:{color:"red"}},e):e}},{title:"库存总量",dataIndex:"stockTotal",key:"stockTotal",render:function(e,t){if(!e)return"";var n=e,a=A.units.find(function(e){return e.code===t.unit});return a&&(n=""+e+a.shortName),t.stockCount<V.STOCK_THRESHOLD_COUNT?j.default.createElement("span",{style:{color:"red"}},n):n}},{title:"数量",dataIndex:"count",key:"count",render:function(e,t){return a.state.isDetail?e:j.default.createElement(k.default,{value:e,onChange:function(e){var n=[].concat(r(a.state.dataSource));n.find(function(e){return e._id===t._id}).count=e,a.setState({dataSource:n}),a.setTotalPrice(n)}})}},{title:"总量",dataIndex:"total",key:"total",render:function(e,t){var n=t.singleUnit,a=t.count,r=void 0===a?0:a,o=1e4*n*r,i=A.units.find(function(e){return e.code===t.unit});return i?""+o/1e4+i.shortName:o}},{title:"总价",dataIndex:"totalPrice",key:"totalPrice",render:function(e,t){var n=t.singleUnit,a=t.unitPrice,r=t.count;return 1e4*n*(void 0===r?0:r)*a*100/1e6+"元"}},{title:"操作",key:"operator",render:function(e,t){if(a.state.isDetail)return"";var n=t._id,r=t.name,o=[{label:"移除",confirm:{title:"您确定要移除“"+r+"”？",onConfirm:function(){var e=a.state.dataSource.filter(function(e){return e._id!==n});a.setState({dataSource:e}),a.setTotalPrice(e)}}}];return j.default.createElement(x.Operator,{items:o})}}],a.handleSubmit=function(e){e.preventDefault();var t=a.state,n=t.loading,r=t.dataSource,o=a.props,i=o.form,l=o.$ajax,u=o.router;if(!n)return r&&r.length?void i.validateFields(function(e,t){if(!e){t.sendTime=new Date,t.products=r,t.products.forEach(function(e){var t=e.singleUnit,n=e.count,a=e.unitPrice;e.totalPrice=t*n*a,e.total=t*n});var n=a.state.isAdd,o=n?l.post:l.put;a.setState({loading:!0}),o("/orders",t).then(function(){S.default.success("订单发起成功",1.5,function(){return u.push("/orders")})}).catch(function(){a.setState({loading:!1})})}}):O.default.error({title:"提示",content:"请添加产品！订单不可以不包含任何产品！"})},a.handleAddProduct=function(){a.setState({showProductSelect:!0})},a.handleProductSelectOk=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];a.setState({showProductSelect:!1}),e&&e.length&&a.props.$ajax.get("products/ids",{ids:e.join(",")}).then(function(e){var t=e.map(function(e){return C({count:1},e)});a.setState({dataSource:t}),a.setTotalPrice(t)})},a.handleReset=function(){a.props.form.resetFields()},a.getReceiveOrgName=function(){var e=a.state,t=e.data,n=e.organizations;if(t&&t.receiveOrgId&&n&&n.length){var r=n.find(function(e){return e._id===t.receiveOrgId});if(r)return r.name}else{var o=a.props.$currentLoginUser.org_id,i=a.getParentOrg(o)||{};if(i)return i.name}},a.handlePrint=function(e){a.setState({printSrc:"/orders/"+e+"/print?"+Date.now()})},l=n,i(a,l)}return l(t,e),I(t,[{key:"componentWillMount",value:function(){var e=this,t=this.props.params.id,n=this.props,a=n.$ajax,r=n.actions,o=!1;if(this.props.location.query&&"true"===this.props.location.query.detail&&(o=!0,this.setState({isDetail:o})),t)this.setState({isAdd:!1}),a.get("/orders/"+t).then(function(t){e.setState({data:t,dataSource:t.products})});else{var i=(0,U.default)().format("YYYYMMDDHHmmss"),l={orderNum:i};this.setState({data:l,isAdd:!0})}a.get("/system/organizations").then(function(t){var n=t||[];e.setState({organizations:n})}),r.setPageTitle("查看订单详情")}},{key:"setTotalPrice",value:function(e){var t=e.reduce(function(e,t){return e+t.singleUnit*t.count*t.unitPrice},0);this.props.form.setFieldsValue({totalPrice:t}),this.setAfterDiscountTotalPrice()}},{key:"setAfterDiscountTotalPrice",value:function(){var e=this;setTimeout(function(){var t=e.props.form,n=t.getFieldValue;(0,t.setFieldsValue)({afterDiscountTotalPrice:n("totalPrice")-n("discount")})})}},{key:"getParentOrg",value:function(e){var t=this.state.organizations,n=t.find(function(t){return t._id===e});if(n){var a=t.find(function(e){return e._id===n.parentId});return a||n}}},{key:"render",value:function(){var e=this,t=this.props,n=t.form,a=n.getFieldDecorator,r=n.getFieldValue,o=t.$currentLoginUser,i=this.state,l=i.loading,u=i.data,c=void 0===u?{}:u,d=i.dataSource,s=i.showProductSelect,m=i.isDetail,h=o.id,g=o.org_id,v=this.getParentOrg(g)||{},S=this.getReceiveOrgName();return j.default.createElement(x.PageContent,null,j.default.createElement("iframe",{src:this.state.printSrc,style:{display:"none"}}),m?null:j.default.createElement("div",{style:{marginBottom:8}},j.default.createElement(b.default,{type:"primary",onClick:this.handleAddProduct},"选择产品")),j.default.createElement(y.default,{size:"small",style:{marginBottom:16},dataSource:d,columns:this.columns,rowKey:function(e){return e._id},pagination:!1}),j.default.createElement(_.default,{onSubmit:this.handleSubmit},c._id?a("_id",{initialValue:c._id})(j.default.createElement(p.default,{type:"hidden"})):null,a("status",{initialValue:0})(j.default.createElement(p.default,{type:"hidden"})),a("sendUserId",{initialValue:h})(j.default.createElement(p.default,{type:"hidden"})),a("sendOrgId",{initialValue:g})(j.default.createElement(p.default,{type:"hidden"})),a("receiveOrgId",{initialValue:c.receiveOrgId||v._id})(j.default.createElement(p.default,{type:"hidden"})),j.default.createElement(x.FormItemLayout,{label:"订单编号",labelSpaceCount:6,float:!0,style:{width:400}},a("orderNum",{initialValue:c.orderNum,rules:[{required:!0,message:"请输入订单编号"}]})(j.default.createElement(p.default,{disabled:!0}))),j.default.createElement(x.FormItemLayout,{label:"订单总价",labelSpaceCount:6,float:!0,style:{width:400}},a("totalPrice",{initialValue:c.totalPrice,rules:[{required:!0,message:"请输入订单总价"}]})(j.default.createElement(p.default,{disabled:!0,type:"hidden"})),(0,R.formatCurrency)(r("totalPrice")||0)),j.default.createElement("div",{style:{clear:"both"}}),j.default.createElement(x.FormItemLayout,{label:"优惠金额",labelSpaceCount:6,float:!0,style:{width:400}},a("discount",{initialValue:c.discount||0,rules:[{required:!0,message:"请输入优惠金额"}],onChange:function(){return e.setAfterDiscountTotalPrice()}})(j.default.createElement(k.default,{style:{width:"100%"},min:0,step:.01,placeholder:"请输入优惠金额",disabled:m}))),j.default.createElement(x.FormItemLayout,{label:"优惠后总价",labelSpaceCount:6,float:!0,style:{width:400}},a("afterDiscountTotalPrice",{initialValue:c.afterDiscountTotalPrice||0,rules:[{required:!0,message:"请输入优惠后总价"}]})(j.default.createElement(p.default,{disabled:!0,type:"hidden"})),(0,R.formatCurrency)(r("afterDiscountTotalPrice")||0)),j.default.createElement("div",{style:{clear:"both"}}),j.default.createElement(x.FormItemLayout,{label:"出货日期",labelSpaceCount:6,float:!0,style:{width:400}},a("deliveryTime",{initialValue:(0,U.default)(c.deliveryTime||new Date),rules:[{required:!0,message:"请选择出货日期"}]})(j.default.createElement(f.default,{showTime:!0,disabled:m,format:"YYYY-MM-DD HH:mm:ss",style:{width:"100%"}}))),j.default.createElement(x.FormItemLayout,{label:"接收部门",labelSpaceCount:6,float:!0,style:{width:400}},a("receiveOrgName",{initialValue:S,rules:[{required:!0,message:"请选择接收部门"}]})(j.default.createElement(p.default,{disabled:!0}))),j.default.createElement("div",{style:{clear:"both"}}),c.rejectReason?j.default.createElement(x.FormItemLayout,{label:"驳回原因",labelSpaceCount:6,style:{width:800}},a("rejectReason",{initialValue:c.rejectReason})(j.default.createElement(p.default,{style:{height:100},disabled:!0,type:"textarea"}))):null,c.destroyReason?j.default.createElement(x.FormItemLayout,{label:"作废原因",labelSpaceCount:6,style:{width:800}},a("destroyReason",{initialValue:c.destroyReason})(j.default.createElement(p.default,{style:{height:100},disabled:!0,type:"textarea"}))):null,j.default.createElement(x.FormItemLayout,{label:"备注",labelSpaceCount:6,style:{width:800}},a("remark",{initialValue:c.remark})(j.default.createElement(p.default,{style:{height:100},disabled:m,type:"textarea",placeholder:"请输入备注、优惠原因、特殊说明等"}))),m&&"1"===c.status?j.default.createElement(x.FormItemLayout,{labelSpaceCount:6},j.default.createElement(b.default,{style:{marginRight:8},loading:l,onClick:function(){return e.handlePrint(c._id)},type:"primary"},"打印")):null,m?null:j.default.createElement(x.FormItemLayout,{labelSpaceCount:6},j.default.createElement(b.default,{style:{marginRight:8},loading:l,type:"primary",onClick:this.handleSubmit},"提交"),j.default.createElement(b.default,{type:"ghost",onClick:this.handleReset},"重置"))),j.default.createElement(L.default,{visible:s,onOk:this.handleProductSelectOk,onCancel:function(){return e.setState({showProductSelect:!1})}}))}}]),t}(T.Component))||d)||d);t.default=q;t.mapStateToProps=function(e){return C({},e.frame)}},1389:function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=t.units=void 0;var l=(n(279),n(177)),u=a(l),c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},d=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),s=n(0),f=a(s),m=u.default.Option,p=t.units=[{code:"squareMetre",name:"平米(㎡)",shortName:"㎡"},{code:"gen",name:"根",shortName:"根"},{code:"zhang",name:"张",shortName:"张"},{code:"kg",name:"千克(kg)",shortName:"kg"},{code:"g",name:"克(g)",shortName:"g"},{code:"t",name:"吨(t)",shortName:"t"},{code:"ge",name:"个",shortName:"个"},{code:"box",name:"箱",shortName:"箱"},{code:"package",name:"包",shortName:"包"},{code:"reel",name:"卷",shortName:"卷"},{code:"bundle",name:"捆",shortName:"捆"},{code:"other",name:"其他",shortName:"其他"}],h=function(e){function t(){var e,n,a,i;r(this,t);for(var l=arguments.length,u=Array(l),c=0;c<l;c++)u[c]=arguments[c];return n=a=o(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(u))),a.state={},i=n,o(a,i)}return i(t,e),d(t,[{key:"render",value:function(){return f.default.createElement(u.default,c({placeholder:"请选择单位"},this.props),p.map(function(e){return f.default.createElement(m,{key:e.code},e.name)}))}}]),t}(s.Component);t.default=h},1414:function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var l,u,c=(n(282),n(281)),d=a(c),s=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),f=n(0),m=a(f),p=n(43),h=n(176),y=n(83),g=n(1389),b=n(50),v=(l=(0,h.ajax)())(u=function(e){function t(){var e,n,a,i;r(this,t);for(var l=arguments.length,u=Array(l),c=0;c<l;c++)u[c]=arguments[c];return n=a=o(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(u))),a.state={total:0,dataSource:[],selectedRowKeys:[]},a.queryItems=[[{type:"input",field:"name",label:"名称",labelSpaceCount:2,width:200,placeholder:"请输入名称"},{type:"input",field:"spec",label:"规格",labelSpaceCount:2,width:200,placeholder:"请输入规格"},{type:"input",field:"model",label:"型号",labelSpaceCount:2,width:200,placeholder:"请输入型号"}]],a.columns=[{title:"名称",dataIndex:"name",key:"name"},{title:"规格",dataIndex:"spec",key:"spec"},{title:"型号",dataIndex:"model",key:"model"},{title:"单位",dataIndex:"unit",key:"unit",render:function(e){var t=g.units.find(function(t){return t.code===e});return t?t.name:e}},{title:"单价",dataIndex:"unitPrice",key:"unitPrice",render:function(e,t){var n=g.units.find(function(e){return e.code===t.unit});return n?(0,y.formatCurrency)(e)+"/"+n.shortName:e}},{title:"单个总量",dataIndex:"singleUnit",key:"singleUnit",render:function(e,t){var n=g.units.find(function(e){return e.code===t.unit});return n?""+e+n.shortName:e}},{title:"单个总价",dataIndex:"singleUnitPrice",key:"singleUnitPrice",render:function(e){return""+(0,y.formatCurrency)(e)}},{title:"库存总数",dataIndex:"stockCount",key:"stockCount",render:function(e){return e<b.STOCK_THRESHOLD_COUNT?m.default.createElement("span",{style:{color:"red"}},e):e}},{title:"库存总量",dataIndex:"stockTotal",key:"stockTotal",render:function(e,t){if(!e)return"";var n=e,a=g.units.find(function(e){return e.code===t.unit});return a&&(n=""+e+a.shortName),t.stockCount<b.STOCK_THRESHOLD_COUNT?m.default.createElement("span",{style:{color:"red"}},n):n}},{title:"备注",dataIndex:"remark",key:"remark"}],a.onSelectChange=function(e){a.setState({selectedRowKeys:e})},a.handleSearch=function(e){return a.props.$ajax.get("/products",e).then(function(e){a.setState({total:e.totalCount,dataSource:e.results})})},a.handleOk=function(){(0,a.props.onOk)(a.state.selectedRowKeys),a.setState({selectedRowKeys:[]})},i=n,o(a,i)}return i(t,e),s(t,[{key:"render",value:function(){var e=this.state,t=e.total,n=e.dataSource,a=e.selectedRowKeys,r=this.props,o=r.visible,i=r.onCancel,l={selectedRowKeys:a,onChange:this.onSelectChange};return m.default.createElement(d.default,{title:"选择产品",visible:o,onOk:this.handleOk,onCancel:i,width:"80%"},m.default.createElement(p.ListPage,{queryItems:this.queryItems,showSearchButton:!0,showResetButton:!1,columns:this.columns,onSearch:this.handleSearch,dataSource:n,rowKey:function(e){return e._id},rowSelection:l,total:t}))}}]),t}(f.Component))||u;t.default=v}});